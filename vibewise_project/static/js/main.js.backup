// Main application controller
class VibeWise {
    constructor() {
        this.currentMood = null;
        this.isDetecting = false;
        this.init();
    }

    async init() {
        await this.loadModels();
        this.setupEventListeners();
        this.initializeCamera();
    }

    async loadModels() {
        try {
            // Path relative to your static files
            const modelPath = '{% static "frontend/libs/models" %}';
            await faceapi.nets.tinyFaceDetector.loadFromUri(modelPath);
            await faceapi.nets.faceExpressionNet.loadFromUri(modelPath);
            console.log('Models loaded successfully');
        } catch (error) {
            console.error('Error loading models:', error);
        }
    }

    setupEventListeners() {
        const startBtn = document.getElementById('startDetection');
        const stopBtn = document.getElementById('stopDetection');
        
        startBtn?.addEventListener('click', () => this.startMoodDetection());
        stopBtn?.addEventListener('click', () => this.stopMoodDetection());
    }

    initializeCamera() {
        Camera.init();
    }

    async startMoodDetection() {
        this.isDetecting = true;
        document.getElementById('startDetection').disabled = true;
        document.getElementById('stopDetection').disabled = false;
        
        await Camera.start();
        MoodDetection.startDetection();
    }

    stopMoodDetection() {
        this.isDetecting = false;
        document.getElementById('startDetection').disabled = false;
        document.getElementById('stopDetection').disabled = true;
        
        Camera.stop();
        MoodDetection.stopDetection();
    }

    updateMood(mood) {
        this.currentMood = mood;
        this.displayMood(mood);
        Playlist.generateRecommendations(mood);
    }

    displayMood(mood) {
        const moodDisplay = document.getElementById('moodDisplay');
        const moodIcon = document.getElementById('moodIcon');
        
        if (moodDisplay) moodDisplay.textContent = mood.charAt(0).toUpperCase() + mood.slice(1);
        if (moodIcon) moodIcon.src = `/assets/images/${mood}.png`;
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.vibeWise = new VibeWise();
});

// In your main.js file, replace the existing toggleTheme function with this:

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme') || 'dark';
  const themes = ['dark', 'light', 'high-contrast', 'colorful', 'neon'];
  const nextIndex = (themes.indexOf(currentTheme) + 1) % themes.length;
  const nextTheme = themes[nextIndex];
  
  // Update theme
  document.body.setAttribute('data-theme', nextTheme);
  localStorage.setItem('vibeWiseTheme', nextTheme);
  
  // Update icon
  const icons = ['ðŸŒ™', 'â˜€ï¸', 'ðŸ”³', 'ðŸŒˆ', 'âš¡'];
  document.querySelector('.theme-icon').textContent = icons[nextIndex];
  
  // Recreate music notes if they exist
  if (window.MusicBackground) {
    MusicBackground.createNotes();
  }
}

// Initialize theme on load
document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('vibeWiseTheme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  
  // Set initial icon
  const themes = ['dark', 'light', 'high-contrast', 'colorful', 'neon'];
  const icons = ['ðŸŒ™', 'â˜€ï¸', 'ðŸ”³', 'ðŸŒˆ', 'âš¡'];
  const initialIndex = themes.indexOf(savedTheme);
  if (document.querySelector('.theme-icon')) {
    document.querySelector('.theme-icon').textContent = 
      initialIndex >= 0 ? icons[initialIndex] : 'ðŸŒ™';
  }
});

// Make sure to expose it to the global scope if your HTML onclick="toggleTheme()" requires it:
window.toggleTheme = toggleTheme;

function setActiveLink() {
  const currentPath = window.location.pathname.split('/').pop() || 'index';
  document.querySelectorAll('.nav-link').forEach(link => {
    const linkPath = link.getAttribute('href').split('/').pop();
    if (linkPath === currentPath) {
      link.classList.add('active');
      link.style.setProperty('--nav-underline-color', 'var(--primary-color)');
    }
  });
}

document.addEventListener('DOMContentLoaded', setActiveLink);